# P&L System Guide

## –ß—Ç–æ —Ç–∞–∫–æ–µ P&L?

**P&L (Profit and Loss)** ‚Äî —Å–∏—Å—Ç–µ–º–∞ —Ä–∞—Å—á–µ—Ç–∞ –ø—Ä–∏–±—ã–ª–∏ –∏ —É–±—ã—Ç–∫–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Ç—Ä–µ–π–¥–µ—Ä–∞.

### –û—Å–Ω–æ–≤–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞:

```
P&L = (–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏ - –¶–µ–Ω–∞ –ø–æ–∫—É–ø–∫–∏) √ó –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ
```

- **–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π P&L** = –ü—Ä–∏–±—ã–ª—å ‚úÖ
- **–û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π P&L** = –£–±—ã—Ç–æ–∫ ‚ùå

## –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–∏—Å—Ç–µ–º–∞ P&L –¥–ª—è SWAP —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π?

### SWAP = –ü–æ–∫—É–ø–∫–∞ + –ü—Ä–æ–¥–∞–∂–∞

SWAP —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ –≤–∫–ª—é—á–∞–µ—Ç –¥–≤–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:

1. **–ü—Ä–æ–¥–∞–∂–∞** –æ–¥–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞ (—Ç—Ä–µ–π–¥–µ—Ä –æ—Ç–¥–∞–µ—Ç —Ç–æ–∫–µ–Ω)
2. **–ü–æ–∫—É–ø–∫–∞** –¥—Ä—É–≥–æ–≥–æ —Ç–æ–∫–µ–Ω–∞ (—Ç—Ä–µ–π–¥–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω)

## –¢–∏–ø—ã P&L

### 1. Unrealized P&L (–ù–µ—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –ø—Ä–∏–±—ã–ª—å/—É–±—ã—Ç–æ–∫)

**–ö–æ–≥–¥–∞:** –¢—Ä–µ–π–¥–µ—Ä –¥–µ—Ä–∂–∏—Ç —Ç–æ–∫–µ–Ω—ã, –Ω–æ –µ—â–µ –Ω–µ –ø—Ä–æ–¥–∞–ª

**–§–æ—Ä–º—É–ª–∞:**
```
Unrealized P&L = (–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞ - –°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ –ø–æ–∫—É–ø–∫–∏) √ó –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ä–∂–∏–º—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤
```

**–ü—Ä–∏–º–µ—Ä:**
```
–¢—Ä–µ–π–¥–µ—Ä –∫—É–ø–∏–ª:
- 1000 BONK @ $0.50 = $500 –ø–æ—Ç—Ä–∞—á–µ–Ω–æ

–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞: $0.60

Unrealized P&L = ($0.60 - $0.50) √ó 1000 = $100 –ø—Ä–∏–±—ã–ª–∏ (–ø–æ–∫–∞ –Ω–µ –ø—Ä–æ–¥–∞–Ω–æ)
```

### 2. Realized P&L (–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –ø—Ä–∏–±—ã–ª—å/—É–±—ã—Ç–æ–∫)

**–ö–æ–≥–¥–∞:** –¢—Ä–µ–π–¥–µ—Ä –ø—Ä–æ–¥–∞–ª —Ç–æ–∫–µ–Ω—ã

**–§–æ—Ä–º—É–ª–∞:**
```
Realized P&L = (–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏ - –°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ –ø–æ–∫—É–ø–∫–∏) √ó –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤
```

**–ü—Ä–∏–º–µ—Ä:**
```
–¢—Ä–µ–π–¥–µ—Ä –∫—É–ø–∏–ª:
- 1000 BONK @ $0.50 = $500 –ø–æ—Ç—Ä–∞—á–µ–Ω–æ

–¢—Ä–µ–π–¥–µ—Ä –ø—Ä–æ–¥–∞–ª:
- 1000 BONK @ $0.55 = $550 –ø–æ–ª—É—á–µ–Ω–æ

Realized P&L = ($0.55 - $0.50) √ó 1000 = $50 –ø—Ä–∏–±—ã–ª–∏ ‚úÖ
```

## –°–∏—Å—Ç–µ–º–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–æ–∑–∏—Ü–∏–π

### –ö–∞–∫ –º—ã –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏ –∫–∞–∂–¥–æ–≥–æ —Ç—Ä–µ–π–¥–µ—Ä–∞?

–î–ª—è –∫–∞–∂–¥–æ–π –ø–∞—Ä—ã **wallet + token** –º—ã –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º:

1. **–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫—É–ø–ª–µ–Ω–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤** (Total Bought)
2. **–û–±—â–∞—è —Å—É–º–º–∞ –ø–æ—Ç—Ä–∞—á–µ–Ω–Ω–∞—è –Ω–∞ –ø–æ–∫—É–ø–∫–∏** (Total Spent)
3. **–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤** (Total Sold)
4. **–û–±—â–∞—è —Å—É–º–º–∞ –ø–æ–ª—É—á–µ–Ω–Ω–∞—è –æ—Ç –ø—Ä–æ–¥–∞–∂** (Total Received)

**–¢–µ–∫—É—â–∞—è –ø–æ–∑–∏—Ü–∏—è:**
```
Current Holding = Total Bought - Total Sold
```

**–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ –≤—Ö–æ–¥–∞:**
```
Average Entry Price = Total Spent / Total Bought
```

## –ü—Ä–∏–º–µ—Ä—ã —Ä–∞—Å—á–µ—Ç–∞ P&L

### –ü—Ä–∏–º–µ—Ä 1: –ü—Ä–æ—Å—Ç–∞—è –ø–æ–∫—É–ø–∫–∞

```
–î–µ–π—Å—Ç–≤–∏–µ: –¢—Ä–µ–π–¥–µ—Ä –ø–æ–∫—É–ø–∞–µ—Ç 1000 BONK –∑–∞ 100 SOL

–†–∞—Å—á–µ—Ç:
- Total Bought = 1000 BONK
- Total Spent = 100 SOL
- Average Entry Price = 100 / 1000 = $0.10 per BONK
- Current Price = $0.12
- Current Holding = 1000 BONK

Unrealized P&L = (0.12 - 0.10) √ó 1000 = +$20 ‚úÖ
Unrealized P&L % = ((0.12 - 0.10) / 0.10) √ó 100 = +20%
```

### –ü—Ä–∏–º–µ—Ä 2: –ü–æ–∫—É–ø–∫–∞ ‚Üí –ü—Ä–æ–¥–∞–∂–∞ (—á–∞—Å—Ç–∏—á–Ω–∞—è)

```
–®–∞–≥ 1: –ü–æ–∫—É–ø–∫–∞
- –ö—É–ø–∏–ª 1000 BONK @ $0.50 = $500 –ø–æ—Ç—Ä–∞—á–µ–Ω–æ

–®–∞–≥ 2: –ü—Ä–æ–¥–∞–∂–∞ (—á–∞—Å—Ç–∏—á–Ω–∞—è)
- –ü—Ä–æ–¥–∞–ª 400 BONK @ $0.60 = $240 –ø–æ–ª—É—á–µ–Ω–æ

–†–∞—Å—á–µ—Ç:
- Total Bought = 1000 BONK
- Total Spent = $500
- Total Sold = 400 BONK
- Total Received = $240
- Average Entry Price = $500 / 1000 = $0.50
- Current Price = $0.60
- Current Holding = 1000 - 400 = 600 BONK

Realized P&L (–æ—Ç –ø—Ä–æ–¥–∞–∂–∏):
= ($0.60 - $0.50) √ó 400 = +$40 ‚úÖ

Unrealized P&L (–æ—Ç –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è):
= ($0.60 - $0.50) √ó 600 = +$60 ‚úÖ

Total P&L = $40 (realized) + $60 (unrealized) = +$100
```

### –ü—Ä–∏–º–µ—Ä 3: –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏

```
–®–∞–≥ 1: –ö—É–ø–∏–ª 1000 BONK @ $0.40 = $400
–®–∞–≥ 2: –ö—É–ø–∏–ª 500 BONK @ $0.60 = $300
–®–∞–≥ 3: –¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞ $0.70

–†–∞—Å—á–µ—Ç:
- Total Bought = 1500 BONK
- Total Spent = $700
- Average Entry Price = $700 / 1500 = $0.4667
- Current Holding = 1500 BONK
- Current Price = $0.70

Unrealized P&L:
= ($0.70 - $0.4667) √ó 1500 = +$350 ‚úÖ

P&L % = ((0.70 - 0.4667) / 0.4667) √ó 100 = +50%
```

### –ü—Ä–∏–º–µ—Ä 4: –ü–æ–ª–Ω–∞—è –ø—Ä–æ–¥–∞–∂–∞ –ø–æ–∑–∏—Ü–∏–∏

```
–®–∞–≥ 1: –ö—É–ø–∏–ª 1000 BONK @ $0.50 = $500
–®–∞–≥ 2: –ü—Ä–æ–¥–∞–ª 1000 BONK @ $0.60 = $600

–†–∞—Å—á–µ—Ç:
- Total Bought = 1000 BONK
- Total Spent = $500
- Total Sold = 1000 BONK
- Total Received = $600
- Average Entry Price = $0.50
- Current Holding = 0 BONK (all sold ‚úì)

Realized P&L = $600 - $500 = +$100 ‚úÖ
P&L % = (($0.60 - $0.50) / $0.50) √ó 100 = +20%
```

## –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤ –∫–æ–¥–µ

### Edge Function: `calculateTokenPnl()`

```typescript
async function calculateTokenPnl(
  supabase: any,
  transactionType: string,
  walletAddress: string,
  tokenMint: string,
  currentAmount: number,
  currentPrice: number
): Promise<{
  tokenPnl: number;
  tokenPnlPercentage: number;
  entryPrice: number;
  remainingTokens: number;
  allTokensSold: boolean;
}>
```

### –õ–æ–≥–∏–∫–∞ —Ä–∞—Å—á–µ—Ç–∞:

#### 1. –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

```typescript
const { data: previousTransactions } = await supabase
  .from("webhook_transactions")
  .select("*")
  .eq("from_address", walletAddress)
  .eq("token_mint", tokenMint)
  .order("block_time", { ascending: true });
```

#### 2. –ü–æ–¥—Å—á–µ—Ç totals –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏

```typescript
let totalBought = 0;
let totalSpentOnBuys = 0;
let totalSold = 0;
let totalReceivedFromSells = 0;

for (const tx of previousTransactions) {
  const amount = Math.abs(parseFloat(tx.amount));
  const price = parseFloat(tx.current_token_price);

  if (tx.transaction_type === "BUY") {
    totalBought += amount;
    totalSpentOnBuys += amount * price;
  } else if (tx.transaction_type === "SELL") {
    totalSold += amount;
    totalReceivedFromSells += amount * price;
  }
}
```

#### 3. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

```typescript
if (transactionType === "BUY") {
  totalBought += absCurrentAmount;
  totalSpentOnBuys += absCurrentAmount * currentPrice;
} else if (transactionType === "SELL") {
  totalSold += absCurrentAmount;
  totalReceivedFromSells += absCurrentAmount * currentPrice;
}
```

#### 4. –†–∞—Å—á–µ—Ç –º–µ—Ç—Ä–∏–∫ –ø–æ–∑–∏—Ü–∏–∏

```typescript
const currentHolding = totalBought - totalSold;
const avgEntryPrice = totalBought > 0 ? totalSpentOnBuys / totalBought : currentPrice;
const allTokensSold = currentHolding <= 0.000001;
```

#### 5. –†–∞—Å—á–µ—Ç P&L

**–î–ª—è BUY (Unrealized P&L):**

```typescript
if (transactionType === "BUY") {
  if (currentHolding > 0 && avgEntryPrice > 0) {
    const currentValue = currentHolding * currentPrice;
    const costBasis = currentHolding * avgEntryPrice;
    pnl = currentValue - costBasis;
    pnlPercentage = ((currentPrice - avgEntryPrice) / avgEntryPrice) * 100;
  }
}
```

**–î–ª—è SELL (Realized P&L):**

```typescript
if (transactionType === "SELL") {
  if (avgEntryPrice > 0) {
    // Realized P&L –æ—Ç –ø—Ä–æ–¥–∞–∂–∏
    const soldValue = absCurrentAmount * currentPrice;
    const soldCost = absCurrentAmount * avgEntryPrice;
    const realizedPnl = soldValue - soldCost;
    pnl = realizedPnl;
    pnlPercentage = ((currentPrice - avgEntryPrice) / avgEntryPrice) * 100;

    // + Unrealized P&L –æ—Ç –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è —Ç–æ–∫–µ–Ω–æ–≤
    if (currentHolding > 0) {
      const unrealizedValue = currentHolding * currentPrice;
      const unrealizedCost = currentHolding * avgEntryPrice;
      const unrealizedPnl = unrealizedValue - unrealizedCost;
      pnl += unrealizedPnl;
    }
  }
}
```

## –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ KOL Feed

### –î–∞–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:

```typescript
{
  transaction_type: "BUY" | "SELL",
  token_symbol: "BONK",
  amount: "1000",
  entry_price: "0.50",
  current_token_price: "0.60",
  token_pnl: "100.00",
  token_pnl_percentage: "20.00",
  remaining_tokens: "1000",
  all_tokens_sold: false
}
```

### –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ BONK                                        ‚îÇ
‚îÇ BUY 1000 @ $0.60                           ‚îÇ
‚îÇ Entry: $0.50                               ‚îÇ
‚îÇ P&L: +$100.00 (+20%)  ‚úÖ                   ‚îÇ
‚îÇ Holding: 1000 BONK                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

### ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–Ω–∞–∫–∞ amount

```typescript
// amount –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º (–∫–æ–≥–¥–∞ wallet –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–æ–∫–µ–Ω—ã)
const absCurrentAmount = Math.abs(currentAmount);
```

### ‚úÖ SOL-first –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è

```typescript
// –ï—Å–ª–∏ SOL –ø–æ—Ç—Ä–∞—á–µ–Ω (negative) = BUY
// –ï—Å–ª–∏ SOL –ø–æ–ª—É—á–µ–Ω (positive) = SELL
if (sol_amount < 0) ‚Üí BUY
if (sol_amount > 0) ‚Üí SELL
```

### ‚úÖ –£—á–µ—Ç —á–∞—Å—Ç–∏—á–Ω—ã—Ö –ø—Ä–æ–¥–∞–∂

```typescript
// Realized P&L –æ—Ç –ø—Ä–æ–¥–∞–∂–∏ + Unrealized P&L –æ—Ç –æ—Å—Ç–∞—Ç–∫–∞
pnl = realizedPnl + unrealizedPnl;
```

### ‚úÖ Real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

```typescript
// Supabase Realtime –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç UI
supabase.channel('webhook_transactions_realtime')
  .on('postgres_changes', { event: 'INSERT' }, handleNewTransaction)
  .subscribe();
```

## –ü—Ä–∏–º–µ—Ä—ã –ª–æ–≥–æ–≤

### BUY —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è:

```
[BUY P&L] Bought: 1000.00, Holding: 1000.00, Entry: $0.50000000,
Current: $0.60000000, Unrealized P&L: $100.00 (+20.00%)
```

### SELL —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è:

```
[SELL P&L] Sold: 400.00 @ $0.60000000, Entry: $0.50000000,
Realized: $40.00 (+20.00%), Remaining: 600.00, Total P&L: $100.00
```

## Summary

‚úÖ **P&L —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é!**
- Unrealized P&L –¥–ª—è –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π
- Realized P&L –¥–ª—è –ø—Ä–æ–¥–∞–∂
- –°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ –≤—Ö–æ–¥–∞ —Å —É—á–µ—Ç–æ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø–æ–∫—É–ø–æ–∫
- –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —á–∞—Å—Ç–∏—á–Ω—ã—Ö –ø—Ä–æ–¥–∞–∂
- Real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ KOL Feed
- –î–µ—Ç–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

**–í—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Ç–µ–ø–µ—Ä—å –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π P&L!** üéâ
